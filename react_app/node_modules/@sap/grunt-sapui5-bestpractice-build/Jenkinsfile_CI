#!groovy
@Library(['piper-lib','features-pipeline-lib','piper-lib-os']) _
import com.sap.icd.jenkins.Utils

def githubOrg = 'devx'
def githubRepo = 'devx-grunt'
def piperUtils
def commitId   

stage('Prepare CI') {
    node {
        checkout scm
        setupPipelineEnvironment script: this, githubOrg: githubOrg, githubRepo: githubRepo, gitBranch: env.BRANCH_NAME
        piperUtils =  new com.sap.icd.jenkins.Utils();
        commitId = piperUtils.getGitCommitId();        
    }
}

stage("voter") {
	node() {
		load "Jenkinsfile_Voter"
	}
}

stage('Checkmarx') {
    node {
        executeCheckmarxScan script: this
    }
}

stage('xMake Stage') {
    node {
        executeBuild script: this, buildType: 'xMakeStage', gitCommitId: commitId
    }
}

stage('IPScan and PPMS') {
    node {
	checkout scm    
	def packageJson = readJSON file: 'package.json'
        measureDuration(script: this, measurementName: 'ppmscheck_duration') {
            executePPMSComplianceCheck script: this, scanType: 'whitesource',
	    whitesourceUserTokenCredentialsId: 'whitesourceKey',
	    whitesourceProjectNames:"${packageJson.name} - ${packageJson.version}"
        }
    }
}

stage('Release') {
    node {
        executeBuild script: this, buildType: 'xMakePromote', gitCommitId: commitId
    }
}
